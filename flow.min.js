/*!
 * Flow.js v1.1.0 - A small JavaScript callbacks synchronizer
 * Copyright (c) Stas Granin - https://github.com/StasGranin/Flow.js
 * License: MIT
 */
(function(){function e(){}var t=function(t,s){var n=this;n._currentTaskIndex=0,n._batch=0,n._syncCounter=0,n._registeredSyncTask=null,n._isAsyncRegistered=!1,n._isFlowRunning=!1,n._tasksCounter=0,n._taskIdCounter=0,n._tasks=[],n._options=s=s||{},s.defaultSync=s.defaultSync||!1,s.onProgress=s.onProgress||e,s.onFail=s.onFail||e,s.onComplete=s.onComplete||e,n._pushTasks(t)};if(t.prototype={_processNext:function(e){var t,s=this;s._isFlowRunning&&e===s._batch&&(t=s._tasks[++s._currentTaskIndex],t&&((s._options.defaultSync&&t.sync!==!1||t.sync===!0)&&s._syncCounter>0?(s._registeredSyncTask=t,s._isAsyncRegistered=!0):s._executeTask(t,void 0,e)))},_executeTask:function(e,s,n){var i,o=this,a=void 0!==s;return"skipped"===e.state?(o._processNext(n),void o._sync(n)):(!a&&o._syncCounter++,void 0===s&&(s=e.failRetries),e.flow&&e.flow instanceof t?i=function(t,s){return e.flow.restart(t,s)}:e.fn&&"function"==typeof e.fn&&(i=e.fn),e.state="executing",i(function(){o._successCallback(Array.prototype.slice.call(arguments,0),e,s,n)},function(){o._failCallback(Array.prototype.slice.call(arguments,0),e,s,n)}),void(!a&&o._processNext(n)))},_successCallback:function(t,s,n,i){var o,a=this,r=s.success||e;a._isFlowRunning&&i===a._batch&&"skipped"!==s.state&&(o=r.apply(null,t),o instanceof Error?(t.unshift(o),a._failCallback(t,s,n,i)):(s.state="succeeded",a._options.onProgress(o),a._sync(i)))},_failCallback:function(e,t,s,n){var i,o=this,a=t.fail||o._defaultFailCallback,r=t.retryInterval;o._isFlowRunning&&n===o._batch&&"skipped"!==t.state&&(i=a.apply(null,e),s?r?("function"==typeof r&&(r=r(s)),setTimeout(function(){o._executeTask(t,--s,n)},parseInt(r)||0)):o._executeTask(t,--s,n):(t.state="failed",t.continueOnFail?o._sync(n):(o._isFlowRunning=!1,o._options.onFail(i),o.executeFail&&o.executeFail(i))))},_sync:function(e){var t=this;setTimeout(function(){t._isFlowRunning&&e===t._batch&&(t._tasksCounter===t._tasks.length-1?t._flowComplete():(t._tasksCounter++,t._syncCounter--,0===t._syncCounter&&t._isAsyncRegistered&&(t._isAsyncRegistered=!1,t._executeTask(t._registeredSyncTask,void 0,e))))},0)},_flowComplete:function(){var e=this;e._isFlowRunning=!1,e._options.onComplete(),e.executeComplete&&e.executeComplete()},_pushTasks:function(e){var t=this;e instanceof Array==!1&&(e=[e]);for(var s=0,n=e.length;n>s;s++)e[s].id||(e[s].id=++t._taskIdCounter),t._tasks.push(e[s])},_defaultFailCallback:function(e){return e},execute:function(e,t){var s=this;return s._isFlowRunning||(s._batch++,s._currentTaskIndex--,s._tasksCounter=0,s._isFlowRunning=!0,s.executeComplete=e,s.executeFail=t,s._processNext(s._batch)),s},restart:function(e,t){var s=this;return s._currentTaskIndex=0,s._isFlowRunning=!1,s._syncCounter=0,s._registeredSyncTask=null,s._isAsyncRegistered=!1,s._tasksCounter=0,s.execute(e,t),s},stop:function(){var e=this;return e._isFlowRunning=!1,e._batch++,e},skipTask:function(e){for(var t,s=this,n=0,i=s._tasks.length;i>n;n++)if(t=s._tasks[n],t.id===e){"executing"===t.state?(t.state="skipped",s._processNext(s._batch),s._sync(s._batch)):t.state="skipped";break}},push:function(e){var t=this;return t._pushTasks(e),t},pushAndExecute:function(e,t,s){var n=this;return n._pushTasks(e),n.execute(t,s),n}},"undefined"!=typeof exports)"undefined"!=typeof module&&module.exports&&(exports=module.exports=t),exports.Flow=t;else{if(this.Flow)throw Error("Flow variable is already assigned");this.Flow=t}}).call(this);